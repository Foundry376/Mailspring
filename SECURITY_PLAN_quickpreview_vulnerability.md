# Security Vulnerability Assessment and Remediation Plan

## Quick Preview Attachment Vulnerability Chain

**Report Date:** January 2, 2026
**Severity:** Critical (CVSS 9.0+)
**Reporter:** Chanho Kim
**Status:** Confirmed - All vulnerabilities verified in codebase

---

## Executive Summary

A critical vulnerability chain has been identified in Mailspring's Quick Preview feature that allows a single malicious email attachment to achieve **persistent Remote Code Execution (RCE)**. The attack requires no user interaction beyond previewing an attachment.

### Attack Chain Overview

```
Malicious .md/.docx attachment
        ↓
   XSS via innerHTML (unsanitized HTML from Snarkdown/Mammoth)
        ↓
   Access to window.electronAPI (exposed IPC)
        ↓
   Directory traversal via flawed path validation
        ↓
   Arbitrary file write to application directory
        ↓
   Overwrite quickpreview/index.js → Persistent RCE
```

---

## Verified Vulnerabilities

### 1. XSS in Quick Preview Renderer

**Status:** ✅ CONFIRMED
**Location:** `app/src/quickpreview/renderer.html:265, 272`
**Severity:** High

**Evidence:**
```javascript
// renderer.html - Lines 264-268
async function runMammoth({ previewPath, mode }) {
  div.innerHTML = await window.electronAPI.previewFileAsMammothHTML(); // VULNERABLE
  ...
}

// renderer.html - Lines 271-278
async function runSnarkdown({ previewPath, mode }) {
  div.innerHTML = await window.electronAPI.previewFileAsSnarkdownHTML(); // VULNERABLE
  ...
}
```

**Root Cause:**
- Snarkdown and Mammoth convert Markdown/DOCX to HTML but do **not sanitize** the output
- HTML is assigned directly to `innerHTML` without sanitization
- Embedded HTML like `<img src="x" onerror="...">` executes JavaScript

**Affected File Types:**
- `.md` (Markdown) - via Snarkdown
- `.docx` (Word documents) - via Mammoth

---

### 2. Exposed Privileged IPC in Renderer Context

**Status:** ✅ CONFIRMED
**Location:** `app/src/quickpreview/preload.js:3-12`
**Severity:** High (when combined with XSS)

**Evidence:**
```javascript
// preload.js - Lines 3-12
contextBridge.exposeInMainWorld('electronAPI', {
  previewFileAsString: (...args) => ipcRenderer.invoke('quickpreview:previewFileAsString', ...args),
  previewFileAsBuffer: (...args) => ipcRenderer.invoke('quickpreview:previewFileAsBuffer', ...args),
  previewFileAsMammothHTML: (...args) => ipcRenderer.invoke('quickpreview:previewFileAsMammothHTML', ...args),
  previewFileAsSnarkdownHTML: (...args) => ipcRenderer.invoke('quickpreview:previewFileAsSnarkdownHTML', ...args),
  finishWithData: (...args) => ipcRenderer.invoke('quickpreview:finishWithData', ...args),  // DANGEROUS
  finishCapture: (...args) => ipcRenderer.invoke('quickpreview:finishCapture', ...args),    // DANGEROUS
});
```

**Root Cause:**
- File-writing IPC handlers (`finishWithData`, `finishCapture`) are exposed to renderer
- XSS-controlled code gains access to these privileged operations
- No authentication or origin validation for IPC calls

---

### 3. Path Validation Bug (Directory Traversal)

**Status:** ✅ CONFIRMED
**Location:** `app/src/browser/quickpreview-ipc.ts:6-11`
**Severity:** Critical

**Evidence:**
```typescript
// quickpreview-ipc.ts - Lines 6-11
const checkPathIsWithinFiles = (filePath: string) => {
  if (!filePath.startsWith(path.join(global.application.configDirPath, 'files'))) {
    throw new Error(`Quick preview cannot access this directory: ${filePath}`);
  }
  return filePath;  // Returns unsanitized path!
};
```

**Root Cause:**
- Uses simple `startsWith()` string check without path normalization
- Does **not** call `path.resolve()` before comparison
- Paths like `<configDir>/files/../../../target` pass validation but resolve outside allowed directory

**Example Bypass:**
```
Input:  /home/user/.config/Mailspring/files/../../.config/Mailspring/app-1.16.0/resources/app.asar.unpacked/src/quickpreview/index.js
Check:  startsWith("/home/user/.config/Mailspring/files") → TRUE (passes)
Actual: Resolves to application code directory (ESCAPES sandbox)
```

---

### 4. Arbitrary File Write via IPC

**Status:** ✅ CONFIRMED
**Location:** `app/src/browser/quickpreview-ipc.ts:43-52`
**Severity:** Critical

**Evidence:**
```typescript
// quickpreview-ipc.ts - Lines 43-52
const finishWithData = (_: IpcMainInvokeEvent, previewPath: string, arrayBuffer) => {
  checkPathIsWithinFiles(previewPath);  // Flawed validation
  fs.writeFileSync(previewPath, Buffer.from(arrayBuffer));  // Arbitrary write
};

const finishCapture = async (event: IpcMainInvokeEvent, previewPath: string) => {
  checkPathIsWithinFiles(previewPath);  // Flawed validation
  const img = await event.sender.capturePage();
  fs.writeFileSync(previewPath, img.toPNG());  // Arbitrary write
};
```

**Root Cause:**
- Both functions accept arbitrary file paths from renderer
- Path validation is bypassable via directory traversal
- Results in arbitrary file write with full user privileges

---

### 5. Persistent RCE via Application Code Overwrite

**Status:** ✅ CONFIRMED
**Location:** `app/src/quickpreview/index.ts:9`
**Severity:** Critical

**Evidence:**
```typescript
// index.ts - Line 9
const filesRoot = __dirname.replace('app.asar', 'app.asar.unpacked');
```

**Root Cause:**
- Quick preview code is in `app.asar.unpacked` (writable on disk)
- Attacker can overwrite `index.js` with malicious code
- Malicious code executes on every subsequent quick preview

**Persistence Mechanism:**
- Modified code survives application restarts
- Executes until application reinstallation or manual file restoration
- Can install additional backdoors, exfiltrate data, etc.

---

## Impact Assessment

| Impact Category | Severity | Description |
|-----------------|----------|-------------|
| **Confidentiality** | Critical | Attacker can read all files accessible to user |
| **Integrity** | Critical | Attacker can modify application code and user data |
| **Availability** | High | Persistent backdoor could disable application functionality |
| **Persistence** | Critical | Survives restarts; requires reinstall to remediate |
| **Attack Complexity** | Low | Single malicious attachment; no special conditions |
| **User Interaction** | Low | Only requires user to preview attachment |

---

## Remediation Plan

### Phase 1: Critical Fixes (Immediate)

#### 1.1 Fix Path Validation (Priority: P0)

**File:** `app/src/browser/quickpreview-ipc.ts`

Replace the current validation with a secure implementation:

```typescript
const checkPathIsWithinFiles = (filePath: string): string => {
  const baseDir = path.join(global.application.configDirPath, 'files');
  const resolvedBase = path.resolve(baseDir);
  const resolvedTarget = path.resolve(filePath);

  // Ensure resolved path is within the allowed directory
  if (!resolvedTarget.startsWith(resolvedBase + path.sep)) {
    throw new Error(`Quick preview cannot access this directory: ${filePath}`);
  }

  return resolvedTarget;  // Return the resolved path
};
```

**Key Changes:**
- Use `path.resolve()` to normalize both base and target paths
- Append `path.sep` to prevent prefix-matching attacks (e.g., `/files-evil/`)
- Return the resolved path to prevent double-resolution issues

#### 1.2 Sanitize HTML Output (Priority: P0)

**File:** `app/src/browser/quickpreview-ipc.ts`

Add HTML sanitization for Mammoth and Snarkdown output:

```typescript
import DOMPurify from 'dompurify';
import { JSDOM } from 'jsdom';

const window = new JSDOM('').window;
const purify = DOMPurify(window);

const previewFileAsMammothHTML = async (event: IpcMainInvokeEvent) => {
  const filepath = getFilePath(event.sender.getURL());
  const mammoth = require('mammoth');
  const result = await mammoth.convertToHtml({ path: filepath });
  return purify.sanitize(result.value);  // Sanitized
};

const previewFileAsSnarkdownHTML = async (event: IpcMainInvokeEvent) => {
  const filepath = getFilePath(event.sender.getURL());
  const md = fs.readFileSync(filepath).toString();
  const html = require('snarkdown')(md);
  return purify.sanitize(html);  // Sanitized
};
```

**Alternative (if DOMPurify is not available in main process):**
- Move sanitization to renderer with a bundled DOMPurify
- Use a Content Security Policy to block inline scripts

#### 1.3 Restrict IPC Surface (Priority: P0)

**Option A: Remove renderer path control**

Modify IPC handlers to use internally-tracked paths only:

```typescript
// Store preview paths in main process
const activePreviews = new Map<number, string>();

const finishWithData = (event: IpcMainInvokeEvent, arrayBuffer: ArrayBuffer) => {
  const previewPath = activePreviews.get(event.sender.id);
  if (!previewPath) throw new Error('No active preview for this window');
  fs.writeFileSync(previewPath, Buffer.from(arrayBuffer));
};
```

**Option B: Use opaque identifiers**

```typescript
// Generate secure tokens for preview operations
const previewTokens = new Map<string, string>();

export function generatePreviewToken(previewPath: string): string {
  const token = crypto.randomBytes(32).toString('hex');
  previewTokens.set(token, previewPath);
  return token;
}

const finishWithData = (_: IpcMainInvokeEvent, token: string, arrayBuffer: ArrayBuffer) => {
  const previewPath = previewTokens.get(token);
  if (!previewPath) throw new Error('Invalid preview token');
  previewTokens.delete(token);
  fs.writeFileSync(previewPath, Buffer.from(arrayBuffer));
};
```

### Phase 2: Defense in Depth (Short-term)

#### 2.1 Add Content Security Policy

**File:** `app/src/quickpreview/index.ts`

Add CSP headers to preview windows:

```typescript
quickPreviewWindow = new BrowserWindow({
  // ... existing options
  webPreferences: {
    preload: path.join(filesRoot, 'preload.js'),
    nodeIntegration: false,
    contextIsolation: true,
  },
});

// Add restrictive CSP
quickPreviewWindow.webContents.session.webRequest.onHeadersReceived((details, callback) => {
  callback({
    responseHeaders: {
      ...details.responseHeaders,
      'Content-Security-Policy': [
        "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;"
      ]
    }
  });
});
```

#### 2.2 Validate Sender URL in IPC Handlers

Add origin validation to ensure IPC calls come from legitimate preview windows:

```typescript
const validateSender = (event: IpcMainInvokeEvent) => {
  const url = new URL(event.sender.getURL());
  if (!url.pathname.endsWith('/renderer.html')) {
    throw new Error('Invalid IPC sender');
  }
};
```

#### 2.3 Limit File Write Permissions

Consider using a sandboxed process or limiting write permissions:

```typescript
const finishWithData = (_: IpcMainInvokeEvent, previewPath: string, arrayBuffer) => {
  const resolvedPath = checkPathIsWithinFiles(previewPath);

  // Only allow writing to .png preview files
  if (!resolvedPath.endsWith('.png')) {
    throw new Error('Only PNG preview files can be written');
  }

  fs.writeFileSync(resolvedPath, Buffer.from(arrayBuffer));
};
```

### Phase 3: Architectural Improvements (Medium-term)

#### 3.1 Consider Sandboxed Renderer

Enable Electron sandbox for preview windows:

```typescript
webPreferences: {
  sandbox: true,
  preload: path.join(filesRoot, 'preload.js'),
  nodeIntegration: false,
  contextIsolation: true,
}
```

#### 3.2 Move Preview Generation to Main Process

Reduce renderer privileges by generating previews in main process:

- Main process reads file and generates HTML
- Renderer only displays pre-sanitized content
- No file-writing IPC exposed to renderer

#### 3.3 Use Separate Process for Untrusted Content

Consider using a utility process or webview with additional isolation for rendering untrusted attachment content.

---

## Testing Plan

### Unit Tests

1. **Path validation tests:**
   - Verify `../` sequences are rejected
   - Verify paths outside `files/` are rejected
   - Verify valid paths within `files/` are accepted
   - Test edge cases: symlinks, null bytes, unicode

2. **HTML sanitization tests:**
   - Verify `<script>` tags are removed
   - Verify event handlers (`onerror`, `onclick`) are removed
   - Verify `javascript:` URLs are removed
   - Verify safe HTML is preserved

### Integration Tests

1. Create malicious `.md` file with XSS payload
2. Verify payload does not execute in preview
3. Verify IPC calls with traversal paths are rejected

### Penetration Testing

1. Re-test the original attack chain after fixes
2. Attempt bypass of new path validation
3. Attempt XSS via other file types (XLSX, etc.)

---

## Deployment Plan

1. **Immediate (Hotfix):**
   - Fix path validation in `quickpreview-ipc.ts`
   - Add HTML sanitization for Mammoth/Snarkdown output

2. **Next Minor Release:**
   - Implement token-based IPC for file writes
   - Add Content Security Policy
   - Add sender URL validation

3. **Future Major Release:**
   - Consider architectural improvements
   - Evaluate sandbox mode for preview windows

---

## Timeline Estimate

| Task | Priority | Complexity |
|------|----------|------------|
| Fix path validation | P0 | Low |
| Add HTML sanitization | P0 | Medium |
| Restrict IPC surface | P0 | Medium |
| Add CSP headers | P1 | Low |
| Validate sender URL | P1 | Low |
| Unit/integration tests | P1 | Medium |

---

## References

- **Affected Files:**
  - `app/src/browser/quickpreview-ipc.ts` (IPC handlers, path validation)
  - `app/src/quickpreview/preload.js` (exposed IPC)
  - `app/src/quickpreview/renderer.html` (innerHTML XSS)
  - `app/src/quickpreview/index.ts` (window configuration)

- **Dependencies:**
  - `snarkdown` - Markdown to HTML (no sanitization)
  - `mammoth` - DOCX to HTML (no sanitization)

- **Security Resources:**
  - [OWASP Path Traversal](https://owasp.org/www-community/attacks/Path_Traversal)
  - [DOMPurify](https://github.com/cure53/DOMPurify)
  - [Electron Security Checklist](https://www.electronjs.org/docs/latest/tutorial/security)

---

## Acknowledgments

Thanks to Chanho Kim for responsibly disclosing this vulnerability chain.
